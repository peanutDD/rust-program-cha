# Rust Unsafe ä»£ç å…¨é¢å­¦ä¹ æŒ‡å—

> åŸºäº https://course.rs/advance/unsafe.html çš„æ·±åº¦åˆ†æ

## ğŸ“š é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å…¨é¢æ·±å…¥åœ°åˆ†æ Rust `unsafe` ä»£ç ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£ä½•æ—¶ä»¥åŠå¦‚ä½•ä½¿ç”¨ unsafe ä»£ç ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œä½ å°†å­¦ä¼šï¼š

- âœ… ç†è§£ unsafe ä»£ç çš„å¿…è¦æ€§
- âœ… æŒæ¡ unsafe çš„äº”ç§èƒ½åŠ›
- âœ… å­¦ä¼šå®‰å…¨åœ°ä½¿ç”¨ unsafe ä»£ç 
- âœ… ç†è§£ unsafe ä»£ç çš„å®‰å…¨è¾¹ç•Œ
- âœ… æŒæ¡ unsafe ä»£ç çš„æœ€ä½³å®è·µ
- âœ… å­¦ä¼šåœ¨å®é™…é¡¹ç›®ä¸­è°¨æ…ä½¿ç”¨ unsafe

## ğŸ“– æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. Unsafe çš„äº”ç§èƒ½åŠ›

**1. è§£å¼•ç”¨è£¸æŒ‡é’ˆï¼š**
```rust
let raw_ptr = &5 as *const i32;
unsafe {
    println!("{}", *raw_ptr);
}
```

**2. è°ƒç”¨ unsafe å‡½æ•°ï¼š**
```rust
unsafe fn dangerous() {}
unsafe {
    dangerous();
}
```

**3. è®¿é—®æˆ–ä¿®æ”¹å¯å˜é™æ€å˜é‡ï¼š**
```rust
static mut COUNTER: u32 = 0;
unsafe {
    COUNTER += 1;
}
```

**4. å®ç° unsafe traitï¼š**
```rust
unsafe trait UnsafeTrait {}
unsafe impl UnsafeTrait for MyType {}
```

**5. è®¿é—®è”åˆä½“çš„å­—æ®µï¼š**
```rust
union MyUnion {
    f1: u32,
    f2: f32,
}
```

### 2. è£¸æŒ‡é’ˆ (Raw Pointers)

**ä¸¤ç§ç±»å‹ï¼š**
```rust
let raw_ptr1: *const i32 = &5;      // ä¸å¯å˜è£¸æŒ‡é’ˆ
let raw_ptr2: *mut i32 = &mut 5;    // å¯å˜è£¸æŒ‡é’ˆ
```

**ä¸å¼•ç”¨çš„åŒºåˆ«ï¼š**
- å¯ä»¥æŒ‡å‘æ— æ•ˆå†…å­˜
- å¯ä»¥å½¢æˆæ‚¬å‚æŒ‡é’ˆ
- ä¸éœ€è¦ç”Ÿå‘½å‘¨æœŸæ³¨è§£
- å¯ä»¥ç»•è¿‡å€Ÿç”¨æ£€æŸ¥

### 3. è°ƒç”¨ Unsafe å‡½æ•°

**å®šä¹‰ unsafe å‡½æ•°ï¼š**
```rust
unsafe fn dangerous() -> i32 {
    // unsafe ä»£ç 
    42
}
```

**è°ƒç”¨ unsafe å‡½æ•°ï¼š**
```rust
unsafe {
    let result = dangerous();
}
```

### 4. åˆ›å»º Safe æŠ½è±¡

**æœ€ä½³å®è·µï¼š**
```rust
// Unsafe å®ç°éšè—åœ¨ safe API å
pub fn safe_wrapper() -> Result<i32, Error> {
    unsafe {
        // å†…éƒ¨ä½¿ç”¨ unsafeï¼Œä½†å¯¹å¤–æ˜¯ safe çš„
        internal_unsafe_function()
    }
}
```

### 5. ä½¿ç”¨å¤–éƒ¨ä»£ç  (FFI)

**è°ƒç”¨ C å‡½æ•°ï¼š**
```rust
extern "C" {
    fn abs(input: i32) -> i32;
}

unsafe {
    println!("{}", abs(-3));
}
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# è¿è¡Œå®Œæ•´æ•™ç¨‹
cargo run

# è¿è¡Œæµ‹è¯•
cargo test
```

## ğŸ“– å­¦ä¹ è·¯å¾„

### 1. åŸºç¡€é˜¶æ®µ
- ç†è§£ unsafe çš„å¿…è¦æ€§
- æŒæ¡äº”ç§ unsafe èƒ½åŠ›
- å­¦ä¹ è£¸æŒ‡é’ˆçš„ä½¿ç”¨

### 2. è¿›é˜¶é˜¶æ®µ
- ç†è§£å®‰å…¨è¾¹ç•Œ
- æŒæ¡ unsafe æŠ½è±¡
- å­¦ä¹  FFI è°ƒç”¨

### 3. é«˜çº§é˜¶æ®µ
- æ„å»º unsafe åº“
- ä¼˜åŒ–æ€§èƒ½
- åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨

## ğŸ’¡ æœ€ä½³å®è·µ

1. **æœ€å°åŒ– unsafe èŒƒå›´**ï¼šåªåœ¨å¿…è¦çš„åœ°æ–¹ä½¿ç”¨
2. **åˆ›å»º safe æŠ½è±¡**ï¼šunsafe å®ç°éšè—åœ¨ safe API å
3. **æ–‡æ¡£å®Œå–„**ï¼šè¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦ unsafe
4. **å……åˆ†æµ‹è¯•**ï¼šunsafe ä»£ç éœ€è¦æ›´å¤šæµ‹è¯•
5. **ä»£ç å®¡æŸ¥**ï¼šunsafe ä»£ç éœ€è¦ä»”ç»†å®¡æŸ¥

## ğŸ” å¸¸è§é™·é˜±

1. **è¿‡åº¦ä½¿ç”¨ unsafe**ï¼šé€ƒé¿å€Ÿç”¨æ£€æŸ¥
2. **æœªå®šä¹‰è¡Œä¸º**ï¼šè¿å Rust å†…å­˜å®‰å…¨ä¿è¯
3. **æ‚¬å‚æŒ‡é’ˆ**ï¼šæŒ‡å‘å·²é‡Šæ”¾çš„å†…å­˜
4. **æ•°æ®ç«äº‰**ï¼šå¤šçº¿ç¨‹ä¸å®‰å…¨è®¿é—®

## ğŸ“š ç›¸å…³èµ„æº

- [Rust Book - Unsafe Rust](https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html)
- [The Rustonomicon](https://doc.rust-lang.org/nomicon/)
- [Unsafe Code Guidelines](https://rust-lang.github.io/unsafe-code-guidelines/)

## âš ï¸ é‡è¦æé†’

**Unsafe ä»£ç å¿…é¡»æ»¡è¶³ï¼š**
- ä¸è¿å Rust çš„å†…å­˜å®‰å…¨ä¿è¯
- ç»´æŠ¤ Rust çš„ä¸å˜é‡
- æä¾›æ­£ç¡®çš„æ–‡æ¡£
- è¿›è¡Œå……åˆ†çš„æµ‹è¯•

**ä½¿ç”¨ unsafe æ—¶ï¼Œä½ æ˜¯åœ¨å‘Šè¯‰ç¼–è¯‘å™¨ï¼š**
"æˆ‘ä¿è¯è¿™æ®µä»£ç æ˜¯å®‰å…¨çš„ï¼Œå³ä½¿ç¼–è¯‘å™¨æ— æ³•éªŒè¯"

## ğŸ¯ æ€»ç»“

Unsafe ä»£ç æ˜¯ Rust çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨éœ€è¦æ—¶ç»•è¿‡å€Ÿç”¨æ£€æŸ¥ï¼Œä½†åŒæ—¶è¦æ±‚æˆ‘ä»¬æ‰‹åŠ¨ä¿è¯å†…å­˜å®‰å…¨ã€‚è°¨æ…ä½¿ç”¨ unsafeï¼Œå¹¶åœ¨ safe API åéšè— unsafe å®ç°ã€‚

---

**Use Unsafe Wisely! ğŸ¦€**
