# Rust é—­åŒ…ï¼ˆClosureï¼‰å…¨é¢å­¦ä¹ æŒ‡å—

æœ¬é¡¹ç›®åŸºäº [Rustè¯­è¨€åœ£ç» - é—­åŒ…ç« èŠ‚](https://course.rs/advance/functional-programing/closure.html) çš„å†…å®¹ï¼Œæä¾›äº† Rust é—­åŒ…çš„å…¨é¢è®²è§£å’Œå®é™…æ¡ˆä¾‹ã€‚

## ğŸ“š é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºå­¦ä¹  Rust é—­åŒ…çš„æ•™å­¦é¡¹ç›®ï¼ŒåŒ…å«äº†ä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨çš„å®Œæ•´å†…å®¹ã€‚é€šè¿‡å¤§é‡çš„ä»£ç ç¤ºä¾‹å’Œè¯¦ç»†çš„æ³¨é‡Šï¼Œå¸®åŠ©ä½ å½»åº•ç†è§£å’ŒæŒæ¡ Rust ä¸­çš„é—­åŒ…æ¦‚å¿µã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬é¡¹ç›®ï¼Œä½ å°†å­¦ä¼šï¼š

- âœ… ç†è§£ä»€ä¹ˆæ˜¯é—­åŒ…ä»¥åŠå®ƒä¸æ™®é€šå‡½æ•°çš„åŒºåˆ«
- âœ… æŒæ¡é—­åŒ…çš„ä¸‰ç§æ•è·æ–¹å¼
- âœ… ç†è§£ `move` å…³é”®å­—çš„ä½œç”¨å’Œä½¿ç”¨åœºæ™¯
- âœ… æ·±å…¥ç†è§£ `Fn`ã€`FnMut`ã€`FnOnce` ä¸‰ç§ trait
- âœ… å­¦ä¼šå°†é—­åŒ…ä½œä¸ºå‡½æ•°å‚æ•°å’Œè¿”å›å€¼
- âœ… æŒæ¡é—­åŒ…åœ¨å®é™…ç¼–ç¨‹ä¸­çš„åº”ç”¨åœºæ™¯
- âœ… äº†è§£é—­åŒ…çš„æ€§èƒ½ç‰¹ç‚¹å’Œæœ€ä½³å®è·µ
- âœ… å­¦ä¹ é«˜çº§é—­åŒ…æŠ€å·§å’Œæ¨¡å¼

## ğŸ“– å†…å®¹ç»“æ„

### 1. åŸºç¡€æ¦‚å¿µ
- é—­åŒ…çš„å®šä¹‰å’Œè¯­æ³•
- é—­åŒ…ä¸å‡½æ•°çš„åŒºåˆ«
- ç±»å‹æ¨å¯¼å’Œæ³¨è§£

### 2. æ•è·æœºåˆ¶
- ä¸å¯å˜å€Ÿç”¨æ•è·
- å¯å˜å€Ÿç”¨æ•è·
- æ‰€æœ‰æƒæ•è·
- `move` å…³é”®å­—è¯¦è§£

### 3. é—­åŒ… Trait
- `FnOnce`: åªèƒ½è°ƒç”¨ä¸€æ¬¡çš„é—­åŒ…
- `FnMut`: å¯å˜é—­åŒ…ï¼Œå¯å¤šæ¬¡è°ƒç”¨
- `Fn`: ä¸å¯å˜é—­åŒ…ï¼Œå¯å¤šæ¬¡è°ƒç”¨
- ä¸‰è€…ä¹‹é—´çš„ç»§æ‰¿å…³ç³»

### 4. å®é™…åº”ç”¨
- é—­åŒ…ä½œä¸ºå‡½æ•°å‚æ•°
- é—­åŒ…ä½œä¸ºè¿”å›å€¼
- è¿­ä»£å™¨ä¸é—­åŒ…
- é”™è¯¯å¤„ç†ä¸­çš„é—­åŒ…
- é…ç½®å’Œç­–ç•¥æ¨¡å¼
- ç¼“å­˜å’Œè®°å¿†åŒ–

### 5. é«˜çº§æŠ€å·§
- é—­åŒ…ç»„åˆ
- æŸ¯é‡ŒåŒ–ï¼ˆCurryingï¼‰
- æƒ°æ€§æ±‚å€¼
- æ€§èƒ½ä¼˜åŒ–

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡Œé¡¹ç›®

```bash
# å…‹éš†é¡¹ç›®ï¼ˆå¦‚æœéœ€è¦ï¼‰
cd closure

# è¿è¡Œä¸»ç¨‹åºï¼ŒæŸ¥çœ‹æ‰€æœ‰ç¤ºä¾‹
cargo run

# è¿è¡Œæµ‹è¯•ç”¨ä¾‹
cargo test

# æŸ¥çœ‹æ–‡æ¡£
cargo doc --open
```

### é¡¹ç›®ç»“æ„

```
closure/
â”œâ”€â”€ Cargo.toml                          # é¡¹ç›®é…ç½®
â”œâ”€â”€ README.md                            # é¡¹ç›®è¯´æ˜ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â””â”€â”€ src/
    â”œâ”€â”€ main.rs                          # ä¸»ç¨‹åºå…¥å£
    â””â”€â”€ closure_comprehensive_guide.rs   # é—­åŒ…å­¦ä¹ æŒ‡å—æ ¸å¿ƒä»£ç 
```

## ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ

### ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿ

é—­åŒ…æ˜¯ä¸€ç§å¯ä»¥æ•è·å…¶ç¯å¢ƒä¸­å˜é‡çš„åŒ¿åå‡½æ•°ã€‚å®ƒæ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„é‡è¦æ¦‚å¿µï¼Œåœ¨ Rust ä¸­æœ‰ç€ç‹¬ç‰¹çš„å®ç°ã€‚

```rust
// åŸºæœ¬è¯­æ³•
let closure = |å‚æ•°| è¡¨è¾¾å¼;
let closure = |å‚æ•°| { è¯­å¥å— };

// ç¤ºä¾‹
let add = |x, y| x + y;
let result = add(5, 3); // 8
```

### ä¸‰ç§ Trait

```rust
// FnOnce - åªèƒ½è°ƒç”¨ä¸€æ¬¡
let consume = || drop(data);

// FnMut - å¯å˜é—­åŒ…
let mut increment = || { count += 1; };

// Fn - ä¸å¯å˜é—­åŒ…
let read_only = || println!("{}", data);
```

### æ•è·æ–¹å¼

```rust
let x = 10;

// ä¸å¯å˜å€Ÿç”¨
let closure1 = || println!("{}", x);

// å¯å˜å€Ÿç”¨
let mut y = 20;
let mut closure2 = || { y += 1; };

// è·å–æ‰€æœ‰æƒ
let data = vec![1, 2, 3];
let closure3 = move || data.len();
```

## ğŸ” é‡è¦çŸ¥è¯†ç‚¹

### 1. é—­åŒ…ç±»å‹æ¨å¯¼

```rust
let closure = |x| x + 1;  // ç¼–è¯‘å™¨æ¨å¯¼ç±»å‹
closure(5);               // ç¡®å®šä¸º i32 -> i32
// closure("hello");      // é”™è¯¯ï¼šç±»å‹å·²ç¡®å®š
```

### 2. move å…³é”®å­—

```rust
let data = vec![1, 2, 3];

// ä¸ä½¿ç”¨ moveï¼šå€Ÿç”¨
let closure1 = || println!("{:?}", data);

// ä½¿ç”¨ moveï¼šè·å–æ‰€æœ‰æƒ
let closure2 = move || println!("{:?}", data);
// println!("{:?}", data); // é”™è¯¯ï¼šdata å·²è¢«ç§»åŠ¨
```

### 3. é—­åŒ…ä½œä¸ºå‚æ•°

```rust
fn apply<F>(f: F, x: i32) -> i32 
where 
    F: Fn(i32) -> i32,
{
    f(x)
}

let double = |x| x * 2;
let result = apply(double, 5); // 10
```

## ğŸ¨ å®é™…åº”ç”¨ç¤ºä¾‹

### è¿­ä»£å™¨å¤„ç†

```rust
let numbers = vec![1, 2, 3, 4, 5];

let result: Vec<i32> = numbers
    .iter()
    .filter(|&&x| x % 2 == 0)  // è¿‡æ»¤å¶æ•°
    .map(|&x| x * x)           // å¹³æ–¹
    .collect();

println!("{:?}", result); // [4, 16]
```

### é”™è¯¯å¤„ç†

```rust
let results: Vec<Result<i32, &str>> = vec!["1", "2", "abc", "4"]
    .iter()
    .map(|s| s.parse().map_err(|_| "è§£æé”™è¯¯"))
    .collect();
```

### é…ç½®æ¨¡å¼

```rust
struct Calculator {
    operation: Box<dyn Fn(f64, f64) -> f64>,
}

let adder = Calculator {
    operation: Box::new(|a, b| a + b),
};
```

## ğŸ”§ æ€§èƒ½è€ƒè™‘

### é›¶æˆæœ¬æŠ½è±¡

Rust çš„é—­åŒ…æ˜¯é›¶æˆæœ¬æŠ½è±¡ï¼Œç¼–è¯‘å™¨ä¼šå°†ç®€å•çš„é—­åŒ…å†…è”ï¼Œæ€§èƒ½ä¸æ‰‹å†™å¾ªç¯ç›¸å½“ã€‚

```rust
// é—­åŒ…ç‰ˆæœ¬
let sum: i32 = numbers.iter().map(|&x| x * 2).sum();

// ç­‰ä»·çš„æ‰‹å†™ç‰ˆæœ¬
let mut sum = 0;
for &x in &numbers {
    sum += x * 2;
}
// ç¼–è¯‘åçš„æœºå™¨ç åŸºæœ¬ç›¸åŒ
```

### æœ€ä½³å®è·µ

1. **ä¼˜å…ˆä½¿ç”¨ `Fn`**ï¼šé™¤ééœ€è¦ä¿®æ”¹æˆ–æ¶ˆè´¹å˜é‡
2. **é¿å…ä¸å¿…è¦çš„ `move`**ï¼šåªåœ¨éœ€è¦æ—¶ä½¿ç”¨
3. **ä¿æŒé—­åŒ…ç®€æ´**ï¼šå¤æ‚é€»è¾‘è€ƒè™‘æå–ä¸ºå‡½æ•°
4. **æ³¨æ„æ•è·çš„å˜é‡**ï¼šåªæ•è·å®é™…éœ€è¦çš„å˜é‡

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

é¡¹ç›®åŒ…å«äº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test test_closure_capture

# æ˜¾ç¤ºæµ‹è¯•è¾“å‡º
cargo test -- --nocapture
```

## ğŸ“š æ‰©å±•å­¦ä¹ 

### æ¨èèµ„æº

1. **å®˜æ–¹æ–‡æ¡£**
   - [The Rust Book - Closures](https://doc.rust-lang.org/book/ch13-01-closures.html)
   - [Rust Reference - Closures](https://doc.rust-lang.org/reference/expressions/closure-expr.html)

2. **åœ¨çº¿æ•™ç¨‹**
   - [Rust è¯­è¨€åœ£ç» - é—­åŒ…](https://course.rs/advance/functional-programing/closure.html)
   - [Rust By Example - Closures](https://doc.rust-lang.org/rust-by-example/fn/closures.html)

3. **è¿›é˜¶ä¸»é¢˜**
   - å¼‚æ­¥ç¼–ç¨‹ä¸­çš„é—­åŒ…
   - å®ä¸é—­åŒ…çš„ç»“åˆ
   - é«˜é˜¶å‡½æ•°è®¾è®¡æ¨¡å¼

### ç»ƒä¹ å»ºè®®

1. **åŸºç¡€ç»ƒä¹ **
   - å®ç°ä¸åŒç±»å‹çš„é—­åŒ…
   - ç»ƒä¹ ä¸‰ç§æ•è·æ–¹å¼
   - ç†è§£ trait çš„åŒºåˆ«

2. **è¿›é˜¶ç»ƒä¹ **
   - å®ç°å‡½æ•°ç»„åˆå™¨
   - åˆ›å»ºè‡ªå®šä¹‰è¿­ä»£å™¨
   - è®¾è®¡åŸºäºé—­åŒ…çš„ DSL

3. **å®æˆ˜é¡¹ç›®**
   - æ„å»ºé…ç½®ç³»ç»Ÿ
   - å®ç°äº‹ä»¶å¤„ç†å™¨
   - å¼€å‘å‡½æ•°å¼æ•°æ®å¤„ç†ç®¡é“

## ğŸ¤ è´¡çŒ®å’Œåé¦ˆ

å¦‚æœä½ å‘ç°ä»»ä½•é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿ï¼š

- æäº¤ Issue æŠ¥å‘Šé—®é¢˜
- æäº¤ Pull Request æ”¹è¿›ä»£ç 
- åˆ†äº«ä½ çš„å­¦ä¹ å¿ƒå¾—

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ LICENSE æ–‡ä»¶ã€‚

---

**Happy Coding! ğŸ¦€**

å¸Œæœ›è¿™ä¸ªé¡¹ç›®èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£ Rust é—­åŒ…çš„ç²¾é«“ã€‚è®°ä½ï¼Œé—­åŒ…ä¸ä»…ä»…æ˜¯è¯­æ³•ç³–ï¼Œå®ƒæ˜¯å‡½æ•°å¼ç¼–ç¨‹æ€æƒ³åœ¨ Rust ä¸­çš„ä½“ç°ï¼ŒæŒæ¡å®ƒå°†è®©ä½ çš„ Rust ä»£ç æ›´åŠ ä¼˜é›…å’Œé«˜æ•ˆï¼