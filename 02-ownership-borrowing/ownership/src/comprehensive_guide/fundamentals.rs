//! # ç¬¬ä¸€éƒ¨åˆ†ï¼šæ‰€æœ‰æƒåŸºç¡€ç†è®º
//!
//! æ‰€æœ‰æƒç³»ç»Ÿæ˜¯ Rust å†…å­˜ç®¡ç†çš„æ ¸å¿ƒï¼ŒåŸºäºä¸‰ä¸ªåŸºæœ¬è§„åˆ™ã€‚

/// ## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ‰€æœ‰æƒåŸºç¡€ç†è®º
///
/// æ‰€æœ‰æƒç³»ç»Ÿæ˜¯ Rust å†…å­˜ç®¡ç†çš„æ ¸å¿ƒï¼ŒåŸºäºä¸‰ä¸ªåŸºæœ¬è§„åˆ™ã€‚
pub fn ownership_fundamentals() {
  println!("\n=== ç¬¬ä¸€éƒ¨åˆ†ï¼šæ‰€æœ‰æƒåŸºç¡€ç†è®º ===");

  ownership_rules_explanation();
  ownership_scope_demonstration();
  string_ownership_examples();
  heap_vs_stack_analysis();
}

/// ### 1.1 æ‰€æœ‰æƒä¸‰å¤§è§„åˆ™
///
/// Rust çš„æ‰€æœ‰æƒç³»ç»ŸåŸºäºä¸‰ä¸ªåŸºæœ¬è§„åˆ™ï¼Œè¿™äº›è§„åˆ™åœ¨ç¼–è¯‘æ—¶è¢«å¼ºåˆ¶æ‰§è¡Œã€‚
fn ownership_rules_explanation() {
  println!("\n--- 1.1 æ‰€æœ‰æƒä¸‰å¤§è§„åˆ™ ---");

  println!("\nğŸ“‹ æ‰€æœ‰æƒè§„åˆ™ï¼š");
  println!("1. Rust ä¸­çš„æ¯ä¸€ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªè¢«ç§°ä¸ºå…¶æ‰€æœ‰è€…ï¼ˆownerï¼‰çš„å˜é‡");
  println!("2. å€¼åœ¨ä»»ä¸€æ—¶åˆ»æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…");
  println!("3. å½“æ‰€æœ‰è€…ï¼ˆå˜é‡ï¼‰ç¦»å¼€ä½œç”¨åŸŸï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒ");

  println!("\nğŸ” è§„åˆ™è¯¦è§£ï¼š");

  // è§„åˆ™ 1 æ¼”ç¤ºï¼šæ¯ä¸ªå€¼éƒ½æœ‰æ‰€æœ‰è€…
  {
    let s = String::from("hello"); // s æ˜¯å­—ç¬¦ä¸²å€¼çš„æ‰€æœ‰è€…
    println!("è§„åˆ™1æ¼”ç¤º: å˜é‡ s æ‹¥æœ‰å­—ç¬¦ä¸² '{}'", s);
  } // s ç¦»å¼€ä½œç”¨åŸŸï¼Œå­—ç¬¦ä¸²è¢«é‡Šæ”¾

  // è§„åˆ™ 2 æ¼”ç¤ºï¼šåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…
  {
    let s1 = String::from("world");
    let s2 = s1; // æ‰€æœ‰æƒä» s1 ç§»åŠ¨åˆ° s2
    // println!("{}", s1);  // ç¼–è¯‘é”™è¯¯ï¼s1 ä¸å†æœ‰æ•ˆ
    println!("è§„åˆ™2æ¼”ç¤º: æ‰€æœ‰æƒå·²ä» s1 ç§»åŠ¨åˆ° s2: {}", s2);
  }

  // è§„åˆ™ 3 æ¼”ç¤ºï¼šç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾
  {
    let s = String::from("auto drop");
    println!("è§„åˆ™3æ¼”ç¤º: {} å°†åœ¨ä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾", s);
  } // è¿™é‡Œ s ç¦»å¼€ä½œç”¨åŸŸï¼Œå†…å­˜è¢«è‡ªåŠ¨é‡Šæ”¾

  println!("âœ“ æ‰€æœ‰æƒè§„åˆ™ç¡®ä¿äº†å†…å­˜å®‰å…¨ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†å†…å­˜");
}

/// ### 1.2 ä½œç”¨åŸŸä¸æ‰€æœ‰æƒ
///
/// ä½œç”¨åŸŸå†³å®šäº†å˜é‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯æ‰€æœ‰æƒç³»ç»Ÿçš„åŸºç¡€ã€‚
fn ownership_scope_demonstration() {
  println!("\n--- 1.2 ä½œç”¨åŸŸä¸æ‰€æœ‰æƒæ¼”ç¤º ---");

  println!("\nğŸ” ä½œç”¨åŸŸå±‚æ¬¡æ¼”ç¤ºï¼š");

  // å¤–å±‚ä½œç”¨åŸŸ
  let outer_var = "å¤–å±‚å˜é‡";
  println!("å¤–å±‚ä½œç”¨åŸŸ: {}", outer_var);

  {
    // å†…å±‚ä½œç”¨åŸŸ
    let inner_var = String::from("å†…å±‚å˜é‡");
    println!("å†…å±‚ä½œç”¨åŸŸ: {}", inner_var);
    println!("å†…å±‚å¯ä»¥è®¿é—®å¤–å±‚: {}", outer_var);

    {
      // æ›´æ·±å±‚ä½œç”¨åŸŸ
      let deep_var = "æ·±å±‚å˜é‡";
      println!("æ·±å±‚ä½œç”¨åŸŸ: {}", deep_var);
      println!("æ·±å±‚å¯ä»¥è®¿é—®å¤–å±‚: {}, {}", outer_var, inner_var);
    } // deep_var åœ¨è¿™é‡Œè¢«é‡Šæ”¾

    println!("å›åˆ°å†…å±‚ä½œç”¨åŸŸ: {}", inner_var);
    // println!("{}", deep_var);  // ç¼–è¯‘é”™è¯¯ï¼deep_var å·²è¶…å‡ºä½œç”¨åŸŸ
  } // inner_var åœ¨è¿™é‡Œè¢«é‡Šæ”¾

  println!("å›åˆ°å¤–å±‚ä½œç”¨åŸŸ: {}", outer_var);
  // println!("{}", inner_var);  // ç¼–è¯‘é”™è¯¯ï¼inner_var å·²è¶…å‡ºä½œç”¨åŸŸ

  println!("âœ“ å˜é‡åœ¨ç¦»å¼€å…¶å®šä¹‰çš„ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾");
}

/// ### 1.3 å­—ç¬¦ä¸²æ‰€æœ‰æƒè¯¦è§£
///
/// é€šè¿‡å­—ç¬¦ä¸²ç±»å‹æ·±å…¥ç†è§£æ‰€æœ‰æƒçš„å·¥ä½œæœºåˆ¶ã€‚
fn string_ownership_examples() {
  println!("\n--- 1.3 å­—ç¬¦ä¸²æ‰€æœ‰æƒè¯¦è§£ ---");

  // å­—ç¬¦ä¸²å­—é¢é‡ vs String ç±»å‹
  println!("\nğŸ” å­—ç¬¦ä¸²ç±»å‹å¯¹æ¯”ï¼š");

  // å­—ç¬¦ä¸²å­—é¢é‡ï¼šå­˜å‚¨åœ¨ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œä¸å¯å˜
  let literal = "å­—ç¬¦ä¸²å­—é¢é‡"; // &str ç±»å‹ï¼Œå­˜å‚¨åœ¨æ ˆä¸Š
  println!("å­—ç¬¦ä¸²å­—é¢é‡: {} (ç±»å‹: &str)", literal);

  // String ç±»å‹ï¼šå¯å˜ï¼Œå­˜å‚¨åœ¨å †ä¸Š
  let mut owned_string = String::from("å¯å˜å­—ç¬¦ä¸²"); // String ç±»å‹ï¼Œæ•°æ®åœ¨å †ä¸Š
  println!("String ç±»å‹: {} (ç±»å‹: String)", owned_string);

  // String çš„æ‰€æœ‰æƒè½¬ç§»
  println!("\nğŸ”„ æ‰€æœ‰æƒè½¬ç§»æ¼”ç¤ºï¼š");

  let s1 = String::from("hello");
  println!("s1 åˆ›å»º: {}", s1);

  let s2 = s1; // æ‰€æœ‰æƒä» s1 ç§»åŠ¨åˆ° s2
  println!("s1 ç§»åŠ¨åˆ° s2: {}", s2);
  // println!("{}", s1);  // ç¼–è¯‘é”™è¯¯ï¼s1 å·²å¤±æ•ˆ

  // å…‹éš†åˆ›å»ºæ·±æ‹·è´
  let s3 = s2.clone(); // åˆ›å»º s2 çš„æ·±æ‹·è´
  println!("s2 å…‹éš†åˆ° s3: s2={}, s3={}", s2, s3);

  // å­—ç¬¦ä¸²ä¿®æ”¹
  owned_string.push_str(" - å·²ä¿®æ”¹");
  println!("ä¿®æ”¹åçš„å­—ç¬¦ä¸²: {}", owned_string);

  println!("âœ“ String ç±»å‹æ¶‰åŠå †å†…å­˜åˆ†é…ï¼Œæ‰€æœ‰æƒè½¬ç§»é¿å…äº†åŒé‡é‡Šæ”¾");
}

/// ### 1.4 å †ä¸æ ˆçš„å†…å­˜åˆ†æ
///
/// ç†è§£ä¸åŒæ•°æ®ç±»å‹åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼ã€‚
fn heap_vs_stack_analysis() {
  println!("\n--- 1.4 å †ä¸æ ˆçš„å†…å­˜åˆ†æ ---");

  println!("\nğŸ“Š å†…å­˜å¸ƒå±€åˆ†æï¼š");

  // æ ˆä¸Šæ•°æ®ï¼šCopy trait
  let x = 5; // å­˜å‚¨åœ¨æ ˆä¸Š
  let y = x; // å¤åˆ¶å€¼ï¼Œä¸æ˜¯ç§»åŠ¨
  println!("æ ˆä¸Šæ•°æ® - x: {}, y: {} (ä¸¤è€…éƒ½æœ‰æ•ˆ)", x, y);

  // å †ä¸Šæ•°æ®ï¼šMove è¯­ä¹‰
  let s1 = String::from("å †ä¸Šæ•°æ®"); // å­—ç¬¦ä¸²æ•°æ®åœ¨å †ä¸Š
  let s2 = s1; // ç§»åŠ¨æ‰€æœ‰æƒï¼Œä¸æ˜¯å¤åˆ¶
  // println!("{}", s1);  // ç¼–è¯‘é”™è¯¯ï¼s1 å·²å¤±æ•ˆ
  println!("å †ä¸Šæ•°æ® - s2: {} (s1 å·²å¤±æ•ˆ)", s2);

  // å¤åˆç±»å‹çš„å†…å­˜å¸ƒå±€
  demonstrate_compound_types_memory();

  println!("\nğŸ’¡ å…³é”®åŒºåˆ«ï¼š");
  println!("â€¢ æ ˆä¸Šæ•°æ®ï¼šå›ºå®šå¤§å°ï¼Œå¿«é€Ÿè®¿é—®ï¼Œè‡ªåŠ¨å¤åˆ¶");
  println!("â€¢ å †ä¸Šæ•°æ®ï¼šåŠ¨æ€å¤§å°ï¼Œéœ€è¦æŒ‡é’ˆè®¿é—®ï¼Œç§»åŠ¨æ‰€æœ‰æƒ");
  println!("â€¢ Copy traitï¼šå…è®¸ç®€å•çš„ä½å¤åˆ¶");
  println!("â€¢ Drop traitï¼šè‡ªå®šä¹‰æ¸…ç†é€»è¾‘");
}

fn demonstrate_compound_types_memory() {
  println!("\nğŸ” å¤åˆç±»å‹å†…å­˜æ¼”ç¤ºï¼š");

  // å…ƒç»„ï¼šå¦‚æœæ‰€æœ‰å…ƒç´ éƒ½å®ç° Copyï¼Œåˆ™å…ƒç»„ä¹Ÿå®ç° Copy
  let tuple1 = (1, 2, 3); // æ‰€æœ‰å…ƒç´ éƒ½æ˜¯ i32ï¼Œå®ç°äº† Copy
  let tuple2 = tuple1; // å¤åˆ¶ï¼Œä¸æ˜¯ç§»åŠ¨
  println!("Copy å…ƒç»„ - tuple1: {:?}, tuple2: {:?}", tuple1, tuple2);

  // åŒ…å« String çš„å…ƒç»„ï¼šä¸å®ç° Copy
  let tuple3 = (String::from("hello"), 42);
  let tuple4 = tuple3; // ç§»åŠ¨æ‰€æœ‰æƒ
  // println!("{:?}", tuple3);  // ç¼–è¯‘é”™è¯¯ï¼
  println!("Move å…ƒç»„ - tuple4: {:?}", tuple4);

  // æ•°ç»„ï¼šå¦‚æœå…ƒç´ ç±»å‹å®ç° Copyï¼Œåˆ™æ•°ç»„ä¹Ÿå®ç° Copy
  let arr1 = [1, 2, 3, 4, 5];
  let arr2 = arr1; // å¤åˆ¶æ•´ä¸ªæ•°ç»„
  println!("Copy æ•°ç»„ - arr1: {:?}, arr2: {:?}", arr1, arr2);
}

