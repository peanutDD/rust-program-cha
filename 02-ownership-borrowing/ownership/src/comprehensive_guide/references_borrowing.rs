//! # ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¼•ç”¨ä¸å€Ÿç”¨æœºåˆ¶
//!
//! å¼•ç”¨å…è®¸ä½¿ç”¨å€¼è€Œä¸è·å–å…¶æ‰€æœ‰æƒï¼Œæ˜¯ Rust ä¸­é‡è¦çš„å†…å­˜ç®¡ç†æœºåˆ¶ã€‚

/// ## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¼•ç”¨ä¸å€Ÿç”¨æœºåˆ¶
///
/// å¼•ç”¨å…è®¸ä½¿ç”¨å€¼è€Œä¸è·å–å…¶æ‰€æœ‰æƒï¼Œæ˜¯ Rust ä¸­é‡è¦çš„å†…å­˜ç®¡ç†æœºåˆ¶ã€‚
pub fn references_and_borrowing() {
  println!("\n=== ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¼•ç”¨ä¸å€Ÿç”¨æœºåˆ¶ ===");

  immutable_references();
  mutable_references();
  borrowing_rules_demonstration();
  dangling_references_prevention();
}

/// ### 3.1 ä¸å¯å˜å¼•ç”¨
///
/// ä¸å¯å˜å¼•ç”¨å…è®¸è¯»å–å€¼ä½†ä¸èƒ½ä¿®æ”¹ã€‚
fn immutable_references() {
  println!("\n--- 3.1 ä¸å¯å˜å¼•ç”¨ ---");

  println!("\nğŸ” åŸºæœ¬å¼•ç”¨æ“ä½œï¼š");

  let s1 = String::from("hello");
  let len = calculate_length(&s1); // ä¼ é€’ s1 çš„å¼•ç”¨
  println!("å­—ç¬¦ä¸² '{}' çš„é•¿åº¦æ˜¯ {}", s1, len); // s1 ä»ç„¶æœ‰æ•ˆ

  fn calculate_length(s: &String) -> usize {
    // s æ˜¯ String çš„å¼•ç”¨
    s.len()
  } // s ç¦»å¼€ä½œç”¨åŸŸï¼Œä½†å› ä¸ºå®ƒä¸æ‹¥æœ‰å¼•ç”¨çš„å€¼ï¼Œæ‰€ä»¥ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿ

  println!("\nğŸ” å¤šä¸ªä¸å¯å˜å¼•ç”¨ï¼š");

  let s2 = String::from("world");
  let r1 = &s2; // ç¬¬ä¸€ä¸ªä¸å¯å˜å¼•ç”¨
  let r2 = &s2; // ç¬¬äºŒä¸ªä¸å¯å˜å¼•ç”¨
  let r3 = &s2; // ç¬¬ä¸‰ä¸ªä¸å¯å˜å¼•ç”¨

  println!("åŸå§‹å€¼: {}", s2);
  println!("å¼•ç”¨1: {}", r1);
  println!("å¼•ç”¨2: {}", r2);
  println!("å¼•ç”¨3: {}", r3);

  println!("\nğŸ” å¼•ç”¨çš„å¼•ç”¨ï¼š");

  let x = 5;
  let y = &x; // y æ˜¯ x çš„å¼•ç”¨
  let z = &y; // z æ˜¯ y çš„å¼•ç”¨ï¼ˆå¼•ç”¨çš„å¼•ç”¨ï¼‰

  println!("x = {}", x);
  println!("y = {} (å¼•ç”¨ x)", y);
  println!("z = {} (å¼•ç”¨ yï¼Œéœ€è¦è§£å¼•ç”¨)", *z);

  // è‡ªåŠ¨è§£å¼•ç”¨
  println!("æ¯”è¾ƒ: x == *y = {}", x == *y);
  println!("æ¯”è¾ƒ: x == **z = {}", x == **z);

  println!("\nğŸ’¡ ä¸å¯å˜å¼•ç”¨ç‰¹ç‚¹ï¼š");
  println!("â€¢ å¯ä»¥æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨");
  println!("â€¢ ä¸èƒ½é€šè¿‡å¼•ç”¨ä¿®æ”¹å€¼");
  println!("â€¢ å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆçš„");
  println!("â€¢ ä½¿ç”¨ & åˆ›å»ºå¼•ç”¨ï¼Œ* è§£å¼•ç”¨");
}

/// ### 3.2 å¯å˜å¼•ç”¨
///
/// å¯å˜å¼•ç”¨å…è®¸ä¿®æ”¹å€Ÿç”¨çš„å€¼ã€‚
fn mutable_references() {
  println!("\n--- 3.2 å¯å˜å¼•ç”¨ ---");

  println!("\nğŸ” åŸºæœ¬å¯å˜å¼•ç”¨ï¼š");

  let mut s = String::from("hello");
  change(&mut s); // ä¼ é€’å¯å˜å¼•ç”¨
  println!("ä¿®æ”¹åçš„å­—ç¬¦ä¸²: {}", s);

  fn change(some_string: &mut String) {
    some_string.push_str(", world");
  }

  println!("\nğŸ” å¯å˜å¼•ç”¨çš„é™åˆ¶ï¼š");

  let mut s1 = String::from("hello");

  {
    let r1 = &mut s1; // ç¬¬ä¸€ä¸ªå¯å˜å¼•ç”¨
    // let r2 = &mut s1;  // ç¼–è¯‘é”™è¯¯ï¼ä¸èƒ½æœ‰ä¸¤ä¸ªå¯å˜å¼•ç”¨
    println!("å¯å˜å¼•ç”¨: {}", r1);
  } // r1 ç¦»å¼€ä½œç”¨åŸŸ

  let r2 = &mut s1; // ç°åœ¨å¯ä»¥åˆ›å»ºæ–°çš„å¯å˜å¼•ç”¨
  println!("æ–°çš„å¯å˜å¼•ç”¨: {}", r2);

  println!("\nğŸ” å¯å˜å¼•ç”¨ä¸ä¸å¯å˜å¼•ç”¨çš„å†²çªï¼š");

  let mut s2 = String::from("hello");

  let r1 = &s2; // ä¸å¯å˜å¼•ç”¨
  let r2 = &s2; // å¦ä¸€ä¸ªä¸å¯å˜å¼•ç”¨
  println!("ä¸å¯å˜å¼•ç”¨: {}, {}", r1, r2);
  // r1 å’Œ r2 åœ¨è¿™é‡Œä¸å†ä½¿ç”¨

  let r3 = &mut s2; // å¯å˜å¼•ç”¨
  println!("å¯å˜å¼•ç”¨: {}", r3);

  // æ¼”ç¤ºå¼•ç”¨ä½œç”¨åŸŸ
  demonstrate_reference_scope();

  println!("\nğŸ’¡ å¯å˜å¼•ç”¨è§„åˆ™ï¼š");
  println!("â€¢ åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨");
  println!("â€¢ å¯å˜å¼•ç”¨ä¸ä¸å¯å˜å¼•ç”¨ä¸èƒ½åŒæ—¶å­˜åœ¨");
  println!("â€¢ å¼•ç”¨çš„ä½œç”¨åŸŸä»åˆ›å»ºå¼€å§‹åˆ°æœ€åä¸€æ¬¡ä½¿ç”¨ç»“æŸ");
}

fn demonstrate_reference_scope() {
  println!("\nğŸ” å¼•ç”¨ä½œç”¨åŸŸæ¼”ç¤ºï¼š");

  let mut s = String::from("hello");

  let r1 = &s; // ä¸å¯å˜å¼•ç”¨å¼€å§‹
  let r2 = &s; // å¦ä¸€ä¸ªä¸å¯å˜å¼•ç”¨
  println!("ä¸å¯å˜å¼•ç”¨: {}, {}", r1, r2);
  // r1 å’Œ r2 çš„ä½œç”¨åŸŸåœ¨è¿™é‡Œç»“æŸï¼Œå› ä¸ºå®ƒä»¬ä¸å†è¢«ä½¿ç”¨

  let r3 = &mut s; // å¯å˜å¼•ç”¨å¼€å§‹
  r3.push_str(", world");
  println!("å¯å˜å¼•ç”¨: {}", r3);
  // r3 çš„ä½œç”¨åŸŸåœ¨è¿™é‡Œç»“æŸ

  // ç°åœ¨å¯ä»¥å†æ¬¡åˆ›å»ºå¼•ç”¨
  let r4 = &s;
  println!("æ–°çš„ä¸å¯å˜å¼•ç”¨: {}", r4);
}

/// ### 3.3 å€Ÿç”¨è§„åˆ™æ¼”ç¤º
///
/// è¯¦ç»†æ¼”ç¤º Rust çš„å€Ÿç”¨æ£€æŸ¥å™¨è§„åˆ™ã€‚
fn borrowing_rules_demonstration() {
  println!("\n--- 3.3 å€Ÿç”¨è§„åˆ™æ¼”ç¤º ---");

  println!("\nğŸ“‹ å€Ÿç”¨è§„åˆ™æ€»ç»“ï¼š");
  println!("1. åœ¨ä»»æ„ç»™å®šæ—¶é—´ï¼Œè¦ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œè¦ä¹ˆåªèƒ½æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨");
  println!("2. å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆçš„");

  println!("\nğŸ” è§„åˆ™1æ¼”ç¤º - å¼•ç”¨äº’æ–¥ï¼š");

  let mut data = vec![1, 2, 3, 4, 5];

  // åœºæ™¯1ï¼šå¤šä¸ªä¸å¯å˜å¼•ç”¨
  {
    let r1 = &data;
    let r2 = &data;
    let r3 = &data;
    println!("å¤šä¸ªä¸å¯å˜å¼•ç”¨: {:?}, {:?}, {:?}", r1, r2, r3);
  }

  // åœºæ™¯2ï¼šå•ä¸ªå¯å˜å¼•ç”¨
  {
    let r1 = &mut data;
    r1.push(6);
    println!("å•ä¸ªå¯å˜å¼•ç”¨: {:?}", r1);
  }

  // åœºæ™¯3ï¼šå¼•ç”¨ä½œç”¨åŸŸä¸é‡å 
  {
    let r1 = &data;
    println!("ä¸å¯å˜å¼•ç”¨: {:?}", r1);
  } // r1 ä½œç”¨åŸŸç»“æŸ

  {
    let r2 = &mut data;
    r2.push(7);
    println!("å¯å˜å¼•ç”¨: {:?}", r2);
  } // r2 ä½œç”¨åŸŸç»“æŸ

  println!("\nğŸ” è§„åˆ™2æ¼”ç¤º - å¼•ç”¨æœ‰æ•ˆæ€§ï¼š");

  // æ­£ç¡®çš„å¼•ç”¨ä½¿ç”¨
  let valid_reference = {
    let s = String::from("valid");
    // return &s;  // ç¼–è¯‘é”™è¯¯ï¼è¿”å›æ‚¬å‚å¼•ç”¨
    s // è¿”å›æ‰€æœ‰æƒ
  };
  println!("æœ‰æ•ˆçš„å€¼: {}", valid_reference);

  // å‡½æ•°ä¸­çš„å€Ÿç”¨
  demonstrate_function_borrowing();

  println!("\nğŸ’¡ å€Ÿç”¨æ£€æŸ¥å™¨çš„ä½œç”¨ï¼š");
  println!("â€¢ åœ¨ç¼–è¯‘æ—¶é˜²æ­¢æ•°æ®ç«äº‰");
  println!("â€¢ ç¡®ä¿å†…å­˜å®‰å…¨");
  println!("â€¢ é¿å…æ‚¬å‚æŒ‡é’ˆ");
  println!("â€¢ é˜²æ­¢è¿­ä»£å™¨å¤±æ•ˆ");
}

fn demonstrate_function_borrowing() {
  println!("\nğŸ” å‡½æ•°å€Ÿç”¨æ¼”ç¤ºï¼š");

  // âœ… ä¼˜åŒ–ï¼šä½¿ç”¨åˆ‡ç‰‡ &[i32] è€Œä¸æ˜¯ &Vec<i32>
  // åˆ‡ç‰‡æ›´é€šç”¨ï¼Œå¯ä»¥æ¥å— Vecã€æ•°ç»„ã€å…¶ä»–åˆ‡ç‰‡çš„å¼•ç”¨
  fn process_data(data: &[i32]) -> i32 {
    data.iter().sum()
  }

  // å¯å˜å€Ÿç”¨å‚æ•°çš„å‡½æ•°
  fn modify_data(data: &mut Vec<i32>) {
    data.push(100);
    data.sort();
  }

  let mut numbers = vec![3, 1, 4, 1, 5, 9];

  // ä¸å¯å˜å€Ÿç”¨
  let sum = process_data(&numbers);
  println!("æ•°æ®å’Œ: {}", sum);

  // å¯å˜å€Ÿç”¨
  modify_data(&mut numbers);
  println!("ä¿®æ”¹åçš„æ•°æ®: {:?}", numbers);

  // åŸå§‹æ•°æ®ä»ç„¶æœ‰æ•ˆ
  println!("åŸå§‹å˜é‡ä»æœ‰æ•ˆ: {:?}", numbers);
}

/// ### 3.4 æ‚¬å‚å¼•ç”¨é˜²æŠ¤
///
/// Rust å¦‚ä½•åœ¨ç¼–è¯‘æ—¶é˜²æ­¢æ‚¬å‚å¼•ç”¨ã€‚
fn dangling_references_prevention() {
  println!("\n--- 3.4 æ‚¬å‚å¼•ç”¨é˜²æŠ¤ ---");

  println!("\nğŸš« æ‚¬å‚å¼•ç”¨ç¤ºä¾‹ï¼ˆç¼–è¯‘é”™è¯¯ï¼‰ï¼š");

  // ä»¥ä¸‹ä»£ç ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯
  /*
  fn dangle() -> &String {  // è¿”å›å­—ç¬¦ä¸²çš„å¼•ç”¨
      let s = String::from("hello");  // s æ˜¯æ–°å­—ç¬¦ä¸²
      &s  // è¿”å›å­—ç¬¦ä¸² s çš„å¼•ç”¨
  }  // s ç¦»å¼€ä½œç”¨åŸŸå¹¶è¢«ä¸¢å¼ƒï¼Œå…¶å†…å­˜è¢«é‡Šæ”¾
     // å¼•ç”¨æŒ‡å‘çš„å†…å­˜å·²è¢«é‡Šæ”¾ï¼
  */

  println!("ä¸Šè¿°ä»£ç æ— æ³•ç¼–è¯‘ï¼Œå› ä¸ºï¼š");
  println!("â€¢ s åœ¨å‡½æ•°ç»“æŸæ—¶è¢«é‡Šæ”¾");
  println!("â€¢ è¿”å›çš„å¼•ç”¨æŒ‡å‘å·²é‡Šæ”¾çš„å†…å­˜");
  println!("â€¢ Rust ç¼–è¯‘å™¨æ£€æµ‹åˆ°æ‚¬å‚å¼•ç”¨");

  println!("\nâœ… æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆï¼š");

  // è§£å†³æ–¹æ¡ˆ1ï¼šè¿”å›æ‰€æœ‰æƒ
  fn no_dangle() -> String {
    let s = String::from("hello");
    s // è¿”å› sï¼Œæ‰€æœ‰æƒç§»åŠ¨åˆ°è°ƒç”¨è€…
  }

  let result1 = no_dangle();
  println!("è¿”å›æ‰€æœ‰æƒ: {}", result1);

  // è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨ç”Ÿå‘½å‘¨æœŸå‚æ•°
  fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() { x } else { y }
  }

  let string1 = String::from("long string");
  let string2 = "short";
  let result2 = longest(&string1, string2);
  println!("æœ€é•¿çš„å­—ç¬¦ä¸²: {}", result2);

  // è§£å†³æ–¹æ¡ˆ3ï¼šä½¿ç”¨é™æ€ç”Ÿå‘½å‘¨æœŸ
  fn get_static_str() -> &'static str {
    "è¿™æ˜¯é™æ€å­—ç¬¦ä¸²" // å­—ç¬¦ä¸²å­—é¢é‡æœ‰ 'static ç”Ÿå‘½å‘¨æœŸ
  }

  let result3 = get_static_str();
  println!("é™æ€å­—ç¬¦ä¸²: {}", result3);

  println!("\nğŸ’¡ é˜²æŠ¤æœºåˆ¶ï¼š");
  println!("â€¢ ç¼–è¯‘æ—¶ç”Ÿå‘½å‘¨æœŸæ£€æŸ¥");
  println!("â€¢ å€Ÿç”¨æ£€æŸ¥å™¨éªŒè¯å¼•ç”¨æœ‰æ•ˆæ€§");
  println!("â€¢ å¼ºåˆ¶æ˜ç¡®ç”Ÿå‘½å‘¨æœŸå…³ç³»");
  println!("â€¢ é›¶è¿è¡Œæ—¶å¼€é”€çš„å®‰å…¨ä¿è¯");
}
